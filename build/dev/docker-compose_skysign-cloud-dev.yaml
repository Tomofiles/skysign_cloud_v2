# To bring up this system:
# docker-compose -f docker-compose_skysign-cloud-dev.yaml -p skysign-cloud-dev up

version: '3.7'

services:

  skysign-communication-db-for-debugging:
    container_name: skysign-communication-db
    hostname: skysign-communication-db
    build:
      context: ../../skysign-db/communication-db
      dockerfile: Dockerfile
    ports:
      - 54321:5432

  skysign-mission-db-for-debugging:
    container_name: skysign-mission-db
    hostname: skysign-mission-db
    build:
      context: ../../skysign-db/mission-db
      dockerfile: Dockerfile
    ports:
      - 54322:5432

  skysign-mq-for-debugging:
    container_name: skysign-mq
    hostname: skysign-mq
    build:
      context: ../../skysign-mq
      dockerfile: Dockerfile
    ports:
      - 56721:5672
      - 15672:15672

  skysign-communication-backend-for-debugging:
    container_name: skysign-communication-backend
    hostname: skysign-communication-backend
    build:
      context: ../../communication
      dockerfile: Dockerfile
    environment:
     - db.host=skysign-communication-db
     - mq.host=skysign-mq
    command: java -cp app:app/lib/* net.tomofiles.skysign.communication.CommunicationApplication
    depends_on:
      - skysign-communication-db-for-debugging
      - skysign-mq-for-debugging

  skysign-mission-backend-for-debugging:
    container_name: skysign-mission-backend
    hostname: skysign-mission-backend
    build:
      context: ../../mission
      dockerfile: Dockerfile
    environment:
     - db.host=skysign-mission-db
    command: java -cp app:app/lib/* net.tomofiles.skysign.mission.MissionApplication
    depends_on:
      - skysign-mission-db-for-debugging

  skysign-helper-backend-for-debugging:
    container_name: skysign-helper-backend
    hostname: skysign-helper-backend
    build:
      context: ../../helper-api
      dockerfile: Dockerfile
    command: /app/helper-user-api

  skysign-communication-gateway-for-debugging:
    container_name: skysign-communication-gateway
    hostname: skysign-communication-gateway
    build:
      context: ../../http_gateway
      dockerfile: Dockerfile
    command: /app/comm-gateway -backend_host skysign-communication-backend -backend_port 5001
    depends_on:
      - skysign-communication-backend-for-debugging

  skysign-vehicle-gateway-for-debugging:
    container_name: skysign-vehicle-gateway
    hostname: skysign-vehicle-gateway
    build:
      context: ../../http_gateway
      dockerfile: Dockerfile
    command: /app/vehicle-gateway -backend_host skysign-communication-backend -backend_port 5001
    depends_on:
      - skysign-communication-backend-for-debugging

  skysign-mission-gateway-for-debugging:
    container_name: skysign-mission-gateway
    hostname: skysign-mission-gateway
    build:
      context: ../../http_gateway
      dockerfile: Dockerfile
    command: /app/mission-gateway -backend_host skysign-mission-backend -backend_port 5001
    depends_on:
      - skysign-mission-backend-for-debugging

  skysign-helper-gateway-for-debugging:
    container_name: skysign-helper-gateway
    hostname: skysign-helper-gateway
    build:
      context: ../../http_gateway
      dockerfile: Dockerfile
    command: /app/helper-gateway -backend_host skysign-helper-backend -backend_port 5001
    depends_on:
      - skysign-helper-backend-for-debugging

  skysign-frontend-for-debugging:
    container_name: skysign-cloud-frontend
    hostname: skysign-cloud-frontend
    build:
      context: ../../client
      dockerfile: Dockerfile

  skysign-cloud-gw-for-debugging:
    container_name: skysign-cloud-gw
    hostname: skysign-cloud-gw
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 8080:80
    depends_on:
      - skysign-communication-gateway-for-debugging
      - skysign-vehicle-gateway-for-debugging
      - skysign-mission-gateway-for-debugging
      - skysign-helper-gateway-for-debugging
      - skysign-frontend-for-debugging

networks:
  default:
    ipam:
      config:
        - subnet: 192.168.5.0/24
      