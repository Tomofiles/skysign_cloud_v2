# Skysign アーキテクチャ・コンセプト
## ユーザーとドローンとクラウドの疎な接続
### 概要
Skysignは、クラウドプラットフォーム上にデプロイされるWebサービスです。
ユーザーおよびドローンは、クラウド上のビジネスロジック・エンティティと、
HTTPを通信プロトコルとしたシンプルなAPIで接続され、
インターネットを介したスケーラブルなコラボレーションを実現します。

Skysignでは、一般的なWebサービスと異なる点として、クラウド上のビジネスロジックから、
ドローンに対して直接コントロール・コマンドを送信するシーンが想定されます。

ユーザーは、クラウドを介して（しかし、クラウドの存在を意識せずとも）、
所有している目の前のドローンに対して、遠隔的な飛行制御と監視ができることを期待しています。

このストーリーを実現するためには、クラウドとドローン間を、サーバー・プッシュな通信プロトコルを用いて、
維持されたドローンとのコネクションを識別して、クラウドからドローンへコマンドを届けなければなりません。

一般的に、コネクション維持型のサーバー・プッシュなアーキテクチャは、
負荷分散の実現にいくぶんかの工夫を施すことを強いられ、仕組みが複雑化する要因になります。

Skysignでは、サーバー・プッシュはあえて採用せず、
InterUSSプロジェクトの[DSS](https://github.com/interuss/dss)にヒントを得て、
[発見と同期のコンセプト](https://github.com/interuss/dss/blob/master/concepts.md)をベースに、
クラウドとドローン間のコミュニケーションのコンセプトを構築しています。

### 発見と同期
発見と同期のコンセプトは、一般的なリソース指向のAPIにシンプルなひと工夫を加えることで実現できます。
ここでは、それぞれ具体的に何を発見し、どうやって同期するのか、説明していきます。

#### 発見
ドローンは、ユーザーからコントロール・コマンド（例えば、ARM/DISARMなど）が送信されたことを検出して、
即座にフライト・コントローラにコマンドを適用したい、という動機があります。

サーバー・プッシュが利用できない状況では、ポーリングで定期的にコマンドを問い合わせするか、
ロング・ポーリングによりコマンドがクラウド上に発生するのを待機するか、などの実装方法が考えられます。

Skysignでは、ポーリングでコマンドをクラウドに問い合わせする方式を採用しています。
ただし、単純にコマンド問い合わせ専用のポーリングを設けると、クラウドに対するアクセスが増加してしまうため、
ドローンからクラウドに対して継続的に行っているテレメトリー送信に、コマンドの問い合わせも含めることにしています。
テレメトリーは、ドローンの機体上の各種センサーの断片的な計測値などを、
ひとまとめにしたデータであり、ドローンの状態を把握するために重要な情報です。

ドローンは、クラウド上の**コミュニケーション**というエンティティと１対１の関係とし、
コミュニケーション・エンティティに対してテレメトリーの更新をクラウドに要求します。
コミュニケーション・エンティティは、ユーザーが所有する機体を表す**ビークル**・エンティティを
作成する際に作成されるもので、ユーザーとも１対１の関係にあります。

ユーザーによるドローンへのコマンドの発行も、コミュニケーション・エンティティを通して行われます。
ユーザーによりクラウドに発行要求されたコマンドは、コミュニケーション・エンティティに格納されます。
ドローンがテレメトリーの更新を要求するたびに、クラウドは格納されたコマンドの存在をチェックし、
テレメトリーの更新要求の応答にコマンドの識別子を含めて、通知します。

ドローンがサービスに対してアクティブな状態の間、テレメトリーは常に送信し続けるため、
ドローンは必ずクラウドからコマンドが発行されたことを発見できるのです。

#### 同期
ドローンは、クラウド上からコマンドが発行されたことを発見すると、取得した識別子を用いて、
クラウドに対して、コマンドの取得要求を送信します。

クラウドは、要求されたコマンドの詳細をドローンに提供すると、コミュニケーション・エンティティから
該当のコマンドを削除します。
一度ドローンに届けたコマンドは、ディアクティブにして再度ドローンに届かないようにしています。

つまり同期は、発見にてクラウドからドローンに対して通知されたコマンドの識別子を元に、
ドローン側のコマンドの取得要求と、クラウド側のコマンドのディアクティブを行う、
一連のプロセスのことを指します。

#### サンプル・シーケンス図
以下のシーケンス図は、ユーザーのビークル・エンティティの作成、および、コマンドの発行と、
ドローンのコマンドの発見と同期を、図示したものです。

![commands_and_telemetry](https://user-images.githubusercontent.com/27773127/113296131-0ec05400-9334-11eb-8245-aa65e5e3de1b.png)

### 課題
現状、発見と同期のコンセプトは有効ではありますが、問題を含んでいます。
ドローンがクラウドに接続された状態から、ユーザーのコマンドの発行を開始する分には問題ないですが、
ドローンが未接続状態でユーザーがコマンドを発行すると、ドローンが接続された瞬間に、
すべてのコマンドが一気にドローンに流れ込み、ドローンが意図しない動作をする可能性があります。