# 本編4 飛行の実行と依存リソースのカーボンコピー

当ドキュメントでは、いよいよ、飛行計画を実行して、実際にドローンを飛行させる機能
の解説に入ります。
**飛行オペレーション**というドメイン・モデルを構築し、飛行計画の実行を実現していきます。

## 計画段階と実行段階の状況的差異
前回、飛行計画はドローンの機体とミッションの紐づけを行い、同時に運航させる
機体の数を決定するものであり、その実体は**艦隊編成**にあるとお話しました。

計画段階にある艦隊編成は、機体数の増減や、ユーザーが所有する機体やミッションの
割り当てに対しては柔軟である必要があり、編集、削除、割り当て、割り当て解除といった、
計画上の必要なオペレーションには、制限がありませんでした。

では、実際に飛行計画を実行して、ドローンのミッション・フライトを開始した後でも、
この状況は変わらないのでしょうか？

例えば、飛行計画の実行中に、計画で使用されているミッションの飛行ルートが
変更されてしまった場合、実行中のフライトはどうなるでしょう？

これは、実際の**オペレーションが計画とズレてしまう**ことになりますし、
なにより、**計画自体が変更されてしまっている**ことに、ほかならない状況です。

計画が実行に移された段階で、**計画の詳細は固定化され**変更不可能となると、
こういった問題は防ぐことができそうです。

しかし、飛行計画が実行に移されたとき、計画に紐づくミッションや機体の編集を
**ロックする**のは、一見合理的に見えて、しかし採用するのは問題があります。  
（なによりも、リソースにステータスの概念を持つと、ドメインの知識として、
色々なものが見えにくくなります）  
また、ドローンの飛行中に、使用されているミッションや機体の編集が不可となることに、
果たして、**ユーザーにとってどのような価値がある**でしょうか？  
制約が多すぎるサービスは、ユーザビリティの低下を招きます。

## リソースをイミュータブルに考える
長くなりましたが、前項の内容を踏まえて、飛行オペレーションのドメイン・モデルについて、
考えていきましょう。  
集約ルートとなる飛行オペレーション・エンティティ（Flightoperation）は、
下図のようにフリート・エンティティを参照するだけのエンティティです。

![domain_models_flightoperation](https://user-images.githubusercontent.com/27773127/113295219-e2580800-9332-11eb-9edf-6664e2e981b7.png)

このままのモデリングでは、前述の通り、飛行オペレーションの状態は、
**艦隊編成の変更の影響を大きく受けて**しまいます。

計画が実行に移ったことで、計画の詳細を固定化するためには、以下の2つの案が考えられます。
- 各リソースにステータスを持たせ、**ロック状態**を切り替えられるようにする
- 各リソースの編集不可な**コピーを作成**して参照させ、元のリソースのみ編集可能とさせる

簡単に言い換えると、前者は**ミュータブル**なリソース、後者を**イミュータブル**なリソースと
呼べるかもしれません。

Skysignでは、後者のイミュータブルなリソースの概念を採用しました。  
飛行オペレーションおよび艦隊編成とその依存リソースに、このルールを適用したイメージを、
以下の図に表現しました。

![domain_models_flightoperation-resource-copy](https://user-images.githubusercontent.com/27773127/113295264-f26fe780-9332-11eb-93c5-06b7c16632d1.png)

飛行計画を実行すると、非同期的に飛行オペレーションのリソースが作成されます。  
その際、対象となるフリートを指定しますが、直接参照させず、**すべての依存リソースの**
**コピーを作成**して参照させます。

コピーは、**新しい識別子**を発行し、元のリソースとは別の集約ルートを作成します。
また、**オリジナルかコピーかを表現するフラグ**も集約ルートに追加し、この切り替えは
ステータス変化ではなくコピー作成時にのみ行えるようにします。

集約ルートのエンティティのすべてのメソッドは、このフラグをチェックすることで、
集約内の状態変化にアクセスできるようにし、凝集度を維持しています。  
（つまり、コピーのときは**編集不可**を実現できる）

コピーおよび識別子の採番は、以下の図のように、ドメインイベントの送受信で、
関連するコンテキスト境界内外に伝播していき、非同期でコピーをしていきます。

![domain_models_flightoperation-and-saga](https://user-images.githubusercontent.com/27773127/113295302-0287c700-9333-11eb-8c7d-66f21058b27f.png)

これは、コンテキスト境界の統合のパターンとして紹介されている、**「Sagaパターン」**
という考え方を取り入れたものです。

Skysignでは、この一連のコピー活動の伝播に**カーボンコピー**と名付け、
ドメイン・モデルに取り入れました。  
カーボンコピーは、メールのCCなどで良く聞く用語ですね。

計画とオペレーションの文脈では、作成された計画書がオペレーション時に複写され、
その複写を共有してオペレーションに挑んでいくイメージで、モデリングされています。

--- 

本編Part.4は、ここで終わりです。  
次のPart.5では、飛行の実績（ドローンが実際に飛行したルートなど）を提供する機能の
説明をしていきます。