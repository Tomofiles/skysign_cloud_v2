# 本編5 飛行の実績と非同期的な飛行データの記録

本編最後は、飛行のオペレーション中のユーザーの操作情報や、
ドローンの動態情報を収集し、飛行の実績を作成する機能の解説を行います。
飛行の実績は、自動的にオペレーション中のドローンの**飛行軌跡\(※\)** の蓄積を行い、
リアルタイムもしくはオンデマンドに、ユーザーに地図上に可視化して提供するものです。

※飛行軌跡：緯度、経度、高度、時間の４次元データで表現される飛行の軌道。
Skysignでは**トラジェクトリー**と呼ぶ（航空管制用語の軌道ベース運航から流用）

以下の画像は、オープンソースGCSのQGCのスクリーンショット（公式より転載）で、
赤い線が飛行軌跡を表すトラジェクトリーにあたる。

![qgc-images](https://mavsdk.mavlink.io/develop/assets/examples/fly_mission/fly_mission_example_qgc.jpg)

## どの集約の役割？
飛行実績は、オペレーション中のユーザーやドローンの行動の履歴のようなもので、
すべてのドローンの運航が完了した後、その日のフライトや以前のフライトを振り返る際に、
活用されることを想定した機能です。

飛行実績は、飛行レポート・エンティティ（Flightreport）という名称で、
以下の図のようにモデリングしています。

![domain_models_flightreport](https://user-images.githubusercontent.com/27773127/113295367-16332d80-9333-11eb-8108-714a29421a6f.png)

飛行オペレーションを完了させることで、飛行レポートが非同期で作成されます。

さて、これで役者は揃いました。  
飛行中のテレメトリーを収集して、飛行実績のトラジェクトリーを作成する集約は、
これらの中のどれになるでしょうか？

まず前提として、テレメトリーは**コミュニケーション**の文脈で扱うのが、
業務上の役割として、より良いと考えられます。
現状、ユーザーとドローンの間のテレメトリーのやり取りは、コミュニケーション・
エンティティの役割です。  
ただ、コミュニケーション・エンティティは、ドローンとのリアルタイムの通信に
特化しているので、飛行実績の文脈に紐づくトラジェクトリーを含めるのは、
凝集度の観点から見て、あまり良い設計ではありません。

それでは、**飛行中**の各種履歴の作用がある点を汲んで、**飛行オペレーション**に含めて
みてはどうでしょうか？  
コミュニケーション・エンティティから、飛行オペレーションに向けて、
テレメトリーが更新されたときに、ドメインイベントを通知してみます。

![domain_models_communication-send-telemetry-updated-event-to-flightoperation](https://user-images.githubusercontent.com/27773127/113295414-23501c80-9333-11eb-82fc-9ac153240e8d.png)

なんとなく良さそうな気がしますが、大きな問題があります。  
ドメインイベントはコミュニケーション・エンティティが知っていること以上の知識は
含められないので、**識別子はコミュニケーションIDのみ**となります。
コミュニケーションIDを知っているのは、機体・エンティティだけなので、
ドメインイベントを飛行オペレーションに送ったところで、何の処理もできないのです。
飛行オペレーション・エンティティは飛行計画への参照しか持っていないので、
受け取ったイベントがどのような情報なのか、正しく解釈できません。

> ◆「問い合わせ」はやめておきたい  
> このとき、機体・エンティティが知っているからと言って、マイクロサービス間通信で
> リクエストして取得してしまうと、お互いが**密結合**になってしまいます。
> 集約として「知らない」ということは、「知ってはいけない」と
> 捉えるべきかもしれません。

同じ理由で、飛行レポート・コンテキストも適当ではありません。

ということで、必然的に、ドメインイベントを機体・エンティティに送るしか、
他に策がないことになりましたが、機体・エンティティは**アイデンティティ**としての
振る舞いしかできない（とルール付けている）ので、こちらも役割としては、
適当ではなさそうです。  
（アイデンティティとステートについては、[本編1](./02_main_paper_1.md)を参照）

![domain_models_communication-send-telemetry-updated-event-to-vehicle](https://user-images.githubusercontent.com/27773127/113295478-3662ec80-9333-11eb-9ab3-0d564fd49d5f.png)

なんとなく見えてきましたが、機体に関連したの識別子に依存していることを考慮すると、
飛行実績を扱う集約は、機体の集約の周囲（もしくは中に含む）に隠れていて、
**まだ見えていない可能性**があります。

## ドメインイベントでのみ更新される集約ルート
ということで、長くなりましたが、Skysignでのモデリングの結果をお話していきます。

まず、機体とコミュニケーションがアイデンティティとステートの関係にあることは、
以前にお話した通りですが、もう一つ、**ステートの集約ルートが追加**になります。  
トラジェクトリーも、それから将来実装しようとしている、ユーザーのコマンドの
送信履歴と、ドローンの返却の履歴も含めて、**ドローンの行動として説明できる**ので、
**アクション**というドメイン・モデルを追加しました。

![domain_models_action](https://user-images.githubusercontent.com/27773127/113295526-45499f00-9333-11eb-9aa9-78c13f90a496.png)

アクション・エンティティ（Action）は、機体のコピーが作成された際に
発行されるドメインイベントを受信して、集約ルートが作成されます。
つまり、飛行計画が実行され、依存リソースがコピーされる際に、コピーされた
機体の識別子で作成されます。  
（このとき、ドメインイベントの中には、機体とコミュニケーションの識別子の
両方が含まれます）

この状態で、コミュニケーション・エンティティからテレメトリー更新のイベントを
受信すると、機体の識別ができるので、トラジェクトリーの蓄積が可能となります。

飛行オペレーションが完了されると、アクションにも完了イベントが通知され、
飛行実績の収集を終了します。

最終的な、集約ルートの関係を図にすると、以下のようになります。

![domain_models_flightreport-and-action](https://user-images.githubusercontent.com/27773127/113295574-55fa1500-9333-11eb-8d6c-e5a583a3a38a.png)

アクションは、集約ルートの作成から、状態の更新、そして最後の終了状態への移行まで、
**すべてドメインイベントにより、コントロールされます**。
ユーザーは、APIによるトラジェクトリー情報の参照のみ、アクセスを許されています。

--- 

これにて、Skysignを構成するすべてのドメイン・モデルの解説が終わりました。  
次回は、まとめ編として、全体にかかるトピックの説明を行って、締めたいと思います。
