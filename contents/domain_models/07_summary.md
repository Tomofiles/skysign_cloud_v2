# まとめ編 境界付けられたコンテキストと統合

本編にて、全5回にわたってSkysignのドメイン・モデルについて、解説してきました。

ドローンをインターネットに接続し、
Web上で簡単にドローンにアクセスできるようになるためには、
様々な業務ドメインが、お互いに影響しあって実現していることが、
本編の5つのドキュメントから、理解していただけたと思います。

当ドキュメントではまとめ編として、これまで紹介してきたドメイン・モデルを統合して、
一つの大きなサービスとして振る舞うための全体アーキテクチャの話を、
少しだけしたいと思います。

## 境界付けられたコンテキストとコア・ドメイン
本編に登場したすべての集約ルートは、Skysignというプロダクト全体を構成する
コンポーネントとして、全部が全部、同じ業務ドメインに属するというわけでも
なさそうです。  
これは、Skysignというドメインには、DDDの文脈における**境界付けられたコンテキスト**が
複数存在する可能性があるということです。

確かに本編では、強調して解説してきた概念がいくつかあり、以下がそれにあたります。

- ドローンとの遠隔コミュニケーション
- 艦隊編成
- 飛行オペレーション
- 飛行実績の自動的な収集

これらはそれぞれ、異なる**言葉**を話しているような、**ゆるいまとまり**を感じます。

この緩やかなまとまりを元に、それぞれの集約の間に境界を引いてみると、
以下の図のようになりました。

![domain_models_bounded-context](https://user-images.githubusercontent.com/27773127/113295633-6ad6a880-9333-11eb-8ede-67b1e74a8872.png)

この4つの境界付けられたコンテキストは、それぞれSkysignの業務ドメインに対応します。

Skysignの売りとして全面的に強調しているドローンとの**遠隔コミュニケーション**は、
これらのドメインの中でも、ひときわ存在感を放っており、**コア・ドメイン**として
他のドメインと区別して開発していくことで、このプロダクトを成功に導く可能性を
秘めています。

そして、他のドメインは**支援サブ・ドメイン**として、プロダクトの付加価値となる
非常に重要な機能を有しているため、コア・ドメインに次いで力を入れることになります。

プロダクトのビジネス的な価値が、ソフトウェアの構成と、開発リソースを優先的に
注ぎ込むべきポイントの発見にまで、ちゃんとつながるのがDDDの良いところだと思います。

## 結果整合性と業務ドメインの分割
本編に少しだけ登場した、結果整合性についても、ここで改めて触れておきます。

**データ整合性**を担保するためには、データベースのトランザクション処理を
使用するのが一般的です。トランザクション処理はデータベース製品が提供している
機能なので信頼性が高く、手軽に利用できるためモノリシックなアーキテクチャでは、
データ整合性の調整に関するすべてを任せてしまっても、アプリケーションは開発できます。

DDDでは、このデータ整合性を担保する方法は、実は2種類あると言っています。
一つが**トランザクション整合性**で、もう一つは**結果整合性**です。

前者は、データ間の業務的関連が強く、必ず同時に更新を成功させないといけないなど、
守るべきルールに強制力がある場合に使用し、後者は、結果的に整合性が取れていれば良く、
一定時間後には帳尻が合っていれば良いなど、ゆるい整合性関係の場合に使用します。

両者を区別し、適切に使い分けられると何が良いのかと言うと、
モノリシックに開発してきたソフトウェアが、実はもっと扱いやすい小さい単位に
分割することができ、**開発やリリースをこまめに実施すること**や、
局所的なスケールアウトにより**サービスの処理能力を向上させること**ができるようになります。

本編で紹介してきたドメイン・モデルにおいては、**コミュニケーション**と**アクション**が
実は結果整合性の関係にあります。

両者は、ドローンの**テレメトリー**と、テレメトリーの蓄積である**トラジェクトリー**を
扱っています。どちらも、ドローンの状態を把握するためには重要なデータであり、
データの内容から見ても、業務的関連性がありそうに見えます。  
そのため、もしかすると、トラジェクトリーをコミュニケーションの集約に
含めるというモデリングをしてしまうかもしれません。

しかし、改めてじっくりと考えてみると、テレメトリーとトラジェクトリーには、
**強い整合性関係**はありません。
テレメトリーが常に最新であることは、ドローンを遠隔操縦しているユーザーにとっては、
大きな価値をもたらしますが、飛行の軌跡であるトラジェクトリーからは、
そのような**リアルタイム性は感じられず**、
最悪、飛行後に蓄積されたものを見れれば良いというレベルかもしれません。
（正直、これはユーザーの要件次第というところでもありますが）

そのため、異なる集約にモデリングすることで、お互いに緩やかな整合性の関係を定め、
さらには、ドメイン・モデルの凝集度を高めることにも繋がり、
コミュニケーションはリアルタイムな状態に責任を持ち、アクションは実績に責任を持つ、
というように**表現力も向上**しています。

---

以上で、ドメイン・モデルの構築に関するドキュメントは終わりです。  
Skysignのアーキテクチャの理解を深める一助となっていれば幸いです。

## 参考文献／サイト
[実践ドメイン駆動設計 (Object Oriented SELECTION) | ヴォーン・ヴァーノン, 髙木 正弘 |本 | 通販 | Amazon](https://www.amazon.co.jp/%E5%AE%9F%E8%B7%B5%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E9%A7%86%E5%8B%95%E8%A8%AD%E8%A8%88-Object-Oriented-SELECTION-%E3%83%B4%E3%82%A1%E3%83%BC%E3%83%B3%E3%83%BB%E3%83%B4%E3%82%A1%E3%83%BC%E3%83%8E%E3%83%B3/dp/479813161X)

[マイクロサービスのドメイン分析 - Azure Architecture Center | Microsoft Docs](https://docs.microsoft.com/ja-jp/azure/architecture/microservices/model/domain-analysis)

[📚 FlytNow User Guide - FlytNow](https://docs.flytnow.com/)

[Overview · QGroundControl User Guide](https://docs.qgroundcontrol.com/master/en/)

[SENSYN FLIGHT CORE｜株式会社センシンロボティクス](https://www.sensyn-robotics.com/technology/flightcore)

---

2021年 4月 Tomofiles